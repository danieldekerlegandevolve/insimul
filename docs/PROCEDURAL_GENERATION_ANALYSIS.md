# Procedural Generation Analysis

## Overview

The **"Create New World: Procedurally Generated"** option creates a complete world with societies, characters, rules, actions, and quests. It combines **Tracery grammar-based generation** for names and narrative text with **AI (Gemini) generation** for rules, actions, quests, and character backstories.

---

## What Gets Procedurally Generated

When you select "Procedurally Generated" in the World Create Dialog, the system generates:

### 1. **Geography & Societies** (No AI/Tracery - Pure Algorithmic)
**Generated by:** `world-generator.ts` + `genealogy-generator.ts` + `geography-generator.ts`

- **Countries** (1 by default)
- **States/Provinces** (2 per country)
- **Settlements** (4 per state: 1 city, 1 town, 2 villages)
- **Districts** (neighborhoods within settlements)
- **Streets** (connecting districts)
- **Buildings** (residences, businesses, landmarks)
- **Businesses** (shops, inns, markets with assigned occupations)

### 2. **Characters & Families** (Uses Tracery for Names)
**Generated by:** `genealogy-generator.ts` + Tracery grammars

**Population Generation:**
- **Founding families** (8 per settlement by default)
- **3 generations** of genealogy
- **Marriage simulation** (connecting families)
- **Children per family** (2 average)
- **Death simulation** (based on death rate)
- **Employment assignment** (characters assigned to businesses)
- **Routines** (daily schedules for each character)

**Tracery Usage for Names:**
```typescript
// Uses name-generator.ts with Tracery Service
TraceryService.expand(grammar.grammar)
```

**Name Grammars Include:**
- First names (medieval, fantasy, modern, etc.)
- Last names (occupational, locational, descriptive)
- Settlement names (themed by world type)
- Business names (taverns, shops, etc.)

**Example Tracery Grammar:**
```json
{
  "origin": ["#firstname# #lastname#"],
  "firstname": ["Aldric", "Brenna", "Cedric", "Damaris"],
  "lastname": ["Blackwood", "Ironforge", "Silverhawk"]
}
```

### 3. **Character Truths** (AI-Generated via Gemini)
**Generated by:** Gemini API in `routes.ts` (lines 3372-3462)

**For each character (up to 50), generates 2-3 truths:**
- **Personality trait or quirk** (e.g., "Has a fear of heights")
- **Secret or hidden past** (e.g., "Once stole from the town treasury")
- **Relationship truth** (e.g., "Secretly in love with the blacksmith")

**Prompt Example:**
```
Generate interesting character truths (backstories, personality traits, 
secrets, relationships) for 50 characters in A medieval-fantasy world 
named "Thornbrook".

For each character, create 2-3 truths that include:
- A defining personality trait or quirk
- A secret or hidden aspect of their past
- A relationship truth or social connection
```

**Storage:** Saved as `Truth` entities linked to characters

### 4. **Social Rules** (AI-Generated via Gemini)
**Generated by:** Gemini API in `routes.ts` (lines 3465-3565)

**Generates 10 social rules about:**
- Social hierarchy and status
- Cultural customs and etiquette
- Taboos and forbidden actions
- Traditions and rituals
- Daily life expectations

**Format:** Insimul rule syntax
```prolog
rule respect_nobility {
  when (
    Character(?commoner) and
    Character(?noble) and
    has_status(?commoner, "commoner") and
    has_status(?noble, "nobility") and
    meets(?commoner, ?noble)
  )
  then {
    bow_to(?commoner, ?noble)
    increase_relationship(?noble, ?commoner, 5)
  }
  priority: 7
  tags: [social, hierarchy]
}
```

**AI Model:** Gemini 2.0 Flash (PRO)
**Temperature:** 0.9 (high creativity)
**Output:** JSON with rule names and Insimul-formatted content

### 5. **Character Actions** (AI-Generated via Gemini)
**Generated by:** Gemini API in `routes.ts` (lines 3567-3634)

**Generates 10 thematic actions:**
- Social interactions (talking, persuading, befriending)
- Physical actions (moving, working, fighting)
- Mental actions (thinking, planning, studying)
- Cultural actions specific to world theme

**Example Actions by Theme:**
- **Medieval:** "Challenge to Duel", "Attend Feast", "Tend Livestock"
- **Cyberpunk:** "Jack Into Matrix", "Corporate Negotiation", "Street Chase"
- **Fantasy:** "Cast Spell", "Commune with Nature", "Forge Enchanted Item"

**AI Model:** Gemini 2.0 Flash (PRO)
**Temperature:** 0.9
**Output:** JSON with name, description, actionType

### 6. **Quests** (AI-Generated via Gemini)
**Generated by:** Gemini API via `gemini-ai.ts` (lines 3636-3679)

**Generates 8 quest storylines:**
- Main quests
- Side quests
- Character-driven storylines

**Format:**
```
questName: description
```

**Example:**
```
The Lost Heir: Search for the missing royal child rumored to be hidden in the countryside
Ancient Curse: Break the curse that has plagued the settlement for generations
Merchant's Dilemma: Help a traveling merchant recover stolen goods
```

**AI Model:** Gemini 2.0 Flash (PRO)
**Storage:** Saved as `Quest` entities with status "active"

---

## Where Tracery is Used

### 1. **Name Generation** (`services/name-generator.ts`)
**Purpose:** Generate character names, place names, business names

**Tracery Service:** `services/tracery-service.ts`
```typescript
import tracery from 'tracery-grammar';

export class TraceryService {
  static expand(
    grammarRules: Record<string, string | string[]>,
    variables?: Record<string, any>,
    startSymbol: string = 'origin'
  ): string {
    const grammar = tracery.createGrammar(grammarRules);
    grammar.addModifiers(tracery.baseEngModifiers); // capitalize, a, s, ed
    return grammar.flatten(`#${startSymbol}#`);
  }
}
```

**Grammar Templates:** `services/grammar-templates.ts`
- Medieval names
- Fantasy names
- Modern names
- Business names
- Settlement names
- Tavern/inn names

**Seeded Grammars:** `seed/seed-grammars.ts`
- Pre-built grammars for common patterns
- Can be extended via AI (`services/grammar-generator.ts`)

### 2. **Narrative Text Generation** (`engines/unified-engine.ts`)
**Purpose:** Generate narrative descriptions during rule execution

**Effect Type:** `generate_text`
```typescript
{
  type: 'generate_text',
  traceryTemplate: 'succession_announcement',
  variables: { heir: 'Princess Elara' }
}
```

**Example Grammar:**
```json
{
  "origin": ["The kingdom announces #heir# as the rightful successor!"],
  "heir": ["Princess Elara", "Prince Marcus"]
}
```

**Execution:**
```typescript
const narrative = TraceryService.expand(
  grammar.grammar,
  effect.variables
);
```

### 3. **Character Interaction Narratives**
**Purpose:** Generate descriptions of character actions

**Example:**
```typescript
// Grammar for tavern interactions
{
  "origin": ["#character# #action# at #location#"],
  "character": ["The warrior", "The merchant", "The bard"],
  "action": ["orders ale", "strikes up a song", "challenges someone to cards"],
  "location": ["the crowded tavern", "the dimly lit corner", "the bar"]
}
```

---

## Where LLMs (Gemini) are Used

### 1. **Character Truths Generation**
**File:** `server/routes.ts` (lines 3372-3462)
**API:** Google Gemini 2.0 Flash
**Model Config:**
```typescript
{
  model: GEMINI_MODELS.PRO, // "gemini-2.0-flash-exp"
  temperature: 0.95,
  responseMimeType: 'application/json'
}
```

**Prompt Structure:**
```
Generate interesting character truths (backstories, personality traits, 
secrets, relationships) for [N] characters in [world context].

Return as JSON:
[
  {
    "characterIndex": 0,
    "truths": [
      {
        "title": "Brief truth title",
        "content": "1-2 sentence description",
        "entryType": "trait|secret|relationship|backstory",
        "importance": 1-10
      }
    ]
  }
]
```

### 2. **Social Rules Generation**
**File:** `server/routes.ts` (lines 3465-3565)
**API:** Google Gemini 2.0 Flash
**Model Config:**
```typescript
{
  model: GEMINI_MODELS.PRO,
  temperature: 0.9,
  responseMimeType: 'application/json'
}
```

**Prompt Structure:**
```
Generate 10 social rules and norms for [world context].

Include rules about:
- Social hierarchy and status
- Cultural customs and etiquette
- Taboos and forbidden actions
- Traditions and rituals
- Daily life expectations

Return as JSON with Insimul rule syntax in "content" field.
```

**Output Format:** Insimul rules (Prolog-like syntax)

### 3. **Character Actions Generation**
**File:** `server/routes.ts` (lines 3567-3634)
**API:** Google Gemini 2.0 Flash
**Model Config:**
```typescript
{
  model: GEMINI_MODELS.PRO,
  temperature: 0.9,
  responseMimeType: 'application/json'
}
```

**Prompt Structure:**
```
Generate 10 character actions for [world context].

Include diverse action types:
- Social interactions (talking, persuading, befriending)
- Physical actions (moving, working, fighting)
- Mental actions (thinking, planning, studying)
- Cultural actions specific to this world's theme

Return as JSON with name, description, actionType.
```

### 4. **Quest Generation**
**File:** `server/routes.ts` (lines 3636-3679)
**API:** Google Gemini 2.0 Flash (via `services/gemini-ai.ts`)
**Function:** `generateBulkRules()`

**Prompt Structure:**
```
Generate quest ideas for [world context]. 
Include main quests, side quests, and character-driven storylines. 
Format each as: "questName: description"
```

### 5. **AI-Powered Grammar Generation** (Optional)
**File:** `services/grammar-generator.ts`
**Purpose:** Generate new Tracery grammars from natural language descriptions

**API:** Google Gemini 2.0 Flash
**Use Cases:**
- Create new name grammars
- Extend existing grammars with variations
- Generate grammars from example outputs

**Example:**
```typescript
const grammar = await grammarGenerator.generateGrammar({
  description: "Generate fantasy creature names",
  theme: "dark fantasy",
  complexity: "medium",
  symbolCount: 5
});
```

### 6. **Single-Shot Name Generation** (Experimental)
**File:** `server/routes.ts` + `generators/name-generator.ts`
**Purpose:** Batch-generate all character names in one API call

**Efficiency:** Much faster than individual name generation
**Fallback:** Uses Tracery if batch generation fails

### 7. **Character Response Generation**
**File:** `services/character-interaction.ts`
**Purpose:** Generate contextual character dialogue

**Prompt:**
```
Character Context: [name, personality, relationships, backstory]

User Query: [player input]

Respond in character, maintaining consistency with the character's 
personality and background.
```

### 8. **Rule Editing with AI**
**File:** `services/gemini-ai.ts`
**Functions:**
- `generateRule()` - Create a single rule from description
- `generateBulkRules()` - Create multiple related rules
- `editRuleWithAI()` - Modify existing rule based on instructions

---

## Generation Flow

### Step-by-Step Process

**1. User Selects "Procedurally Generated"**
```typescript
// client/src/components/WorldCreateDialog.tsx
const generateContent = creationMode === 'procedural';
onCreateWorld(data, generateContent, worldType, prompt);
```

**2. World Created**
```typescript
// client/src/components/WorldSelectionScreen.tsx
const response = await apiRequest('POST', '/api/worlds', data);
const newWorld = await response.json();
```

**3. Generation Triggered**
```typescript
// POST to /api/generate/complete-world
const genResponse = await apiRequest('POST', '/api/generate/complete-world', {
  worldId: newWorld.id,
  worldType,
  customPrompt,
  worldName: data.name,
  worldDescription: data.description,
});
```

**4. Background Generation Starts**
```typescript
// server/routes.ts - runs async
progressTracker.startTask(taskId);
res.json({ taskId });

// Background process:
// → Step 1: Geography (40%)
// → Step 2: Character Truths (48%)
// → Step 3: Social Rules (65%)
// → Step 4: Actions (85%)
// → Step 5: Quests (95%)
// → Complete (100%)
```

**5. Frontend Polls Progress**
```typescript
// client/src/components/GenerationProgressDialog.tsx
// Polls /api/generate/progress/:taskId every 500ms
```

---

## Configuration

### World Types (Theme Presets)
```typescript
const WORLD_TYPES = [
  'medieval-fantasy', 'high-fantasy', 'low-fantasy', 'dark-fantasy',
  'urban-fantasy', 'sci-fi-space', 'cyberpunk', 'post-apocalyptic',
  'steampunk', 'dieselpunk', 'historical-ancient', 'historical-medieval',
  'historical-renaissance', 'historical-victorian', 'wild-west',
  'modern-realistic', 'superhero', 'horror', 'mythological', 'solarpunk'
];
```

Each world type influences:
- AI-generated content themes
- Name grammar selection
- Rule/action/quest themes
- Settlement descriptions

### Generation Parameters
```typescript
{
  numCountries: 1,
  generateStates: true,
  numStatesPerCountry: 2,
  numCitiesPerState: 1,
  numTownsPerState: 1,
  numVillagesPerState: 2,
  generateGenealogy: true,
  generateGeography: true,
  numFoundingFamilies: 8,
  generations: 3,
  governmentType: 'monarchy',
  economicSystem: 'feudal',
  terrain: 'plains'
}
```

### API Key Requirements

**Required for AI Features:**
```bash
GEMINI_API_KEY=your_key_here
```

**Without API Key:**
- Geography ✅ (still works)
- Characters ✅ (names via Tracery)
- Character Truths ❌ (skipped)
- Social Rules ❌ (skipped)
- Actions ❌ (skipped)
- Quests ❌ (skipped)

---

## Performance Optimizations

### 1. **Single-Shot Name Generation**
**Problem:** Individual API calls for each name = slow
**Solution:** Batch-generate all names in one Gemini call

```typescript
// Estimate total names needed
const totalNames = numSettlements * numFamilies * (generations * 2);

// Single API call generates all at once
const allNames = await nameGenerator.generateNamesBatch(context, totalNames);
```

**Speed Improvement:** ~10x faster

### 2. **Async Background Generation**
**Problem:** Frontend blocked during long generation
**Solution:** Return `taskId` immediately, generate in background

```typescript
// Return immediately
res.json({ taskId });

// Generate in background
(async () => {
  await generateEverything();
  progressTracker.completeTask(taskId);
})();
```

### 3. **Progress Tracking**
**File:** `server/utils/progress-tracker.ts`
**Purpose:** Track long-running generation tasks

```typescript
progressTracker.updateProgress(taskId, 'rules', 'Generating rules...', 65);
```

**Frontend polls:**
```typescript
GET /api/generate/progress/:taskId
```

---

## File Organization

### **Core Generation**
- `server/generators/world-generator.ts` - Main orchestrator
- `server/generators/genealogy-generator.ts` - Family trees
- `server/generators/geography-generator.ts` - Districts, streets, buildings
- `server/generators/name-generator.ts` - AI name generation

### **Tracery System**
- `server/services/tracery-service.ts` - Tracery wrapper
- `server/services/name-generator.ts` - Name gen with Tracery
- `server/services/grammar-templates.ts` - Pre-built grammars
- `server/services/grammar-generator.ts` - AI grammar generation
- `server/seed/seed-grammars.ts` - Seeded grammar database

### **AI/LLM Integration**
- `server/services/gemini-ai.ts` - Gemini wrapper for rules/actions
- `server/services/character-interaction.ts` - Character dialogue
- `server/config/gemini.ts` - API configuration

### **Routes**
- `server/routes.ts` (lines 2710-2770) - Generation endpoints
- `server/routes.ts` (lines 3273-3693) - Complete world generation

---

## Summary

**Procedural Generation Breakdown:**

| Component | Method | Tool |
|-----------|--------|------|
| **Geography** | Algorithmic | Pure code |
| **Families/Genealogy** | Algorithmic | Pure code |
| **Character Names** | Grammar-based | **Tracery** |
| **Settlement Names** | Grammar-based | **Tracery** |
| **Business Names** | Grammar-based | **Tracery** |
| **Character Truths** | AI-generated | **Gemini (LLM)** |
| **Social Rules** | AI-generated | **Gemini (LLM)** |
| **Character Actions** | AI-generated | **Gemini (LLM)** |
| **Quests** | AI-generated | **Gemini (LLM)** |
| **Narrative Text** | Grammar-based | **Tracery** |

**Technology Stack:**
- **Tracery** - Fast, offline grammar-based text generation
- **Google Gemini** - AI-powered contextual content generation
- **Hybrid Approach** - Names via Tracery, content via AI

**Result:** A complete, immersive world with:
- Realistic geography and societies
- Named characters with relationships
- Backstories and personality traits
- Social rules and norms
- Character actions and interactions
- Quest storylines
